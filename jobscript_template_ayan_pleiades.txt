#!/bin/bash

#This template is adapted from Molly's foggie/examples/RunScript.sh; see there for explanations

#PBS -N RUN_NAME

##### Resources #####
#PBS -W group_list=PROJ_CODE
#PBS -l RESOURCES
#PBS -l walltime=NHOURS:00:00

##### Queue #####
#PBS -q QNAME

##### Mail Options #####
#PBS -m abe
#PBS -M ayan.acharyya@inaf.it

#set output and error directories
#PBS -j oe
#PBS -o pbs_RUN_NAME.out

###### Load necessary modules #########
module purge
module load mpi-hpe/mpt.2.30
source /home5/aachary2/miniconda3/etc/profile.d/conda.sh
source activate py380

export PYTHONPATH=$PYTHONPATH:/home5/aachary2/miniconda3/envs/py380/bin/python

# --- PRE-FLIGHT CHECK ---
echo "Checking Python path actual..."
ls -l /home5/aachary2/miniconda3/envs/py380/bin/python
echo $PYTHONPATH
echo "Checking Python path fetched..."
which python

# ------------------------

##### Change to current working directory #####
cd WORKDIR

##### Execute Program #####
top -b -u $USER -n NSECONDS 1>top_RUN_NAME.out &
mpiexec -n NCPUS python CALLFILE SYSTEMFLAG HALOFLAG RUNSIMFLAG OUTPUT_FLAG OPT_ARGS 1>output_RUN_NAME.out 2>&1
killall 'top'